# 운영체제 스터디 2회차

<img width="674" alt="스크린샷 2021-06-12 오후 7 38 57" src="https://user-images.githubusercontent.com/70311145/121813565-7a655c80-cca7-11eb-8aac-14ec8286dc36.png">

이번 강의는 이 그림 한장을 설명할 수 있다면 다 배운것 같다,, 난이도 급격하게 올라가는 것 무엇 ,,😂

[이미지 출처](https://core.ewha.ac.kr/publicview/C0101020140311132925816476?vmode=f)

## 컴퓨터 시스템의 동작 원리

### 컴퓨터 시스템 구조

컴퓨터 시스템의 구조는 컴퓨터 내부장치인 CPU, 메모리 그리고 외부장치인 디스크, I/O장치, 네트워크 장치 등으로 구성된다.

- 메모리 - CPU의 작업 공간, CPU는 메모리하고만 일을 한다.
- 레지스터 - CPU안에서 메모리보다 빠른 `작은` 저장 공간

외부장치에서 내부장치로 데이터를 읽어와 각종 연산을 수행 후, 그 결과를 외부장치로 다시 보내는 방식으로 업무를 처리한다.

- inout(입력) - 컴퓨터 내부로 데이터가 들어오는 것
- output(출력) - 컴퓨터 외부 장치로 데이터가 나가는 것

입출력 I/O 장치의 예) 키보드, 모니터, 스피커 등등,,,

디스크 - 컴퓨터의 외부장치. 그러므로 컴퓨터 내부에서 연산 후 디스크에 데이터를 저장했다면 입력과 출력을 한것과 같음

하드웨어 장치(메모리, 입출력 장치 등)에는 컨트롤러가 붙어있다.

- 컨트롤러 - 일종의 작은 CPU로서, 컴퓨터 전체에 중앙처리장치(CPU)가 있듯 각 하드웨어 장치마다 존재하며 이들을 제어한다.

운영체제는 컴퓨터의 전원이 ON일 경우 항상 쉬지않고 일을 수행하며 각종 자원들을 관리해야하기에

항상 메모리에 올라가 있다. 이러한 경우 운영체제의 모든 코드가 메모리에 상주시키면

메모리의 낭비가 발생하게 된다.

`커널 - 운영체제 중 항상 메모리에 올라가 있는 부분은 전부 운영체제 중 핵심적인 부분에 한정`

---

### CPU 연산과 I / O 연산

컴퓨터에서 연산을 한다는 것은 CPU가 무언가 일을 한다는 뜻이다.

컴퓨터 외부에서는 각 컨트롤러가 입출력을 담당하며, 내부에서는 메인 CPU가 담당하게 된다.

I/O장치마다 이를 제어하기 위해 설치된 장치 컨트롤러는 장치로부터 들어오고 나가는 데이터를

임시로 저장하기 위한 작은 메모리를 가지고 있는데 이것을 `로컬버퍼`라고 부른다.

키보드 또는 디스크에서 데이터를 읽어오면 이 로컬버퍼에 데이터가 임시로 저장된 후 메모리로 전달된다.

이때 장치에서 로컬버퍼로 읽어오는 일은 컨틀롤러가 담당한다.

1. 프로그램 B에서 데이터를 읽어오라는 명령을 내림
2. 디스크 컨트롤러가 물리적인 디스크에서 내용을 읽어 로컬버퍼에 저장
3. 원하는 데이터를 로컬버퍼로 전부 읽어 온 후 프로그램 B는 메인 CPU에서 다음 일을 수행

위 작업이 끝난 후 장치에 있는 컨트롤러는 인터럽트를 발생시켜 CPU에 보고하게 된다.

- 인터럽트 - 컨트롤러들이 CPU의 서비스가 필요할 때 이를 통보하는 방법

CPU는 매 시점 메모리에 명령(instruction)을 `하나씩` 읽어와서 수행한다.

이때 인터럽트 라인을 통해 CPU가 자신의 작업을 하던 중간에 인터럽트 라인에 신호가 들어오면 하던 일을 멈추고

인터럽트와 관련된 일을 `먼저 처리`한다. `CPU는 명령 하나를 수행할 때마다 인터럽트가 발생했는지 확인함`

인터럽트는 키보드 입력 혹인 요청된 디스크 입출력 작업의 완료 등 CPU에게 보고할 이벤트가 일어난 경우 컨트롤러가 발생시키는 것이다.

### 인터럽트의 일반적 기능과 핸들링

운영체제 커널에는 인터럽트가 들어왔을 때 해야 할 일이 미리 다 프로그래밍되어 코드로 보관돼 있다.

커널 내에 있는 인터럽트 처리루틴은 다양한 인터럽트에 대해 각각 처리해야 할 업무들을 정의한다.

1. 디스크 컨트롤러가 인터럽트를 발생
2. CPU는 하던 일을 잠시 멈추고 인터럽트가 발생했을 때 수행하도록 정의된 코드를 찾아 수행
3. 수행하는 일은 디스크의 로컬버퍼에 있는 애용을 사용자 프로그램의 메모리로 전달
4. 해당 프로그램이 CPU를 할당받을 경우 다음 명령을 수행할 수 있음을 표시

운영체제는 할 일을 쉽게 찾아가기 위해 `인터럽트 벡터`를 가지고 있다.

- 인터럽트 벡터 - 인터럽트 종류마다 번호를 정해서, 번호에 따라 처리해야 할 코드가 위치한 부분을 가리키는 자료구조

실제 처리해야 할 코드는 인터럽트 처리루틴 또는 인터럽트 핸들러라는 다른 곳에 정의된다.

인터럽트 처리루틴을 통해 해당 인터럽트 처리 후 원래 수행중이던 작업으로 돌아가 중단되었든 일을 계속 수행한다.

인터럽트 처리 후 돌아갈 위치를 알아야 하므로 인터럽트 처리 전에 수행중이던 작업이 무엇이었는지 `반드시 저장`해야 한다.

이러한 정보를 저장하기 위한 장소를 운영체제는 별도로 가지고 있다.

위와 같은 인터럽트의 일반적인 기능은 **하드웨어 인터럽트**를 의미한다.

**소프트웨어 인터럽트??**

`트랩`이라는 요어로도 불린다. 소프트웨어 인터럽트는 예외상황(exception)과 시스템 콜(system call)이 있다.

- 예외상황 - 사용자 프로그램이 0으로 나누는 연산 등 비정상적인 작업을 시도하거나, 권한이 없는 작업을 시도할 때

  이에 대한 처리를 위해 발생시키는 인터럽트

- 시스템 콜 - 사용자 프로그램이 운영체제 내부에 정의된 코드를 실행하고 싶을 때 운영체제 서비스를 요청하는 방법.

사용자 프로그램 자신의 코드는 직접 CPU를 가지고 실행한다.

하지만 이 프로그램에 정의되지 않고 커널에 있는 코드를 사용자 프로그램이 실행하고자 할 때에는

인터럽트 라인 세팅을 통해 CPU 제어권을 운영체제로 넘겨 실행하게 된다.

- ?? 무슨 말이야,, - 개발자가 프로그램 작성 중 키보드 입력 또는 화면 출력 등의 입출력 작업이 필요할 때

  본인이 직접 입출력을 수행하는 코드를 작성하는 것이 아닌 이미 존재하는 커널의 코드를 호출해서 처리한다.

**핸들링**

인터럽트가 발생한 경우에 처리해야 할 일의 절차를 의미한다.

1. 프로그램 1이 실행되고 인터럽트가 발생
2. 프로그램 1의 현재 상태를 먼저 저장

- 현재 상태란? - 현재 CPU에서 실행 중인 명령의 메모리 주소를 포함한 몇 가지 부가적인 정보들

현대 컴퓨터의 운영체제는 인터럽트가 발생할 경우에만 실행된다.

운영체제가 직접 CPU를 점유하는 경우는 인터럽트에 의하지 않고는 발생하지 않는다.

---

### DMA (Direct Memory Access - 직접 메모리 접근)

컨트롤러가 CPU에게 인터럽트를 발생시키면 CPU는 컨트롤러의 로컬버퍼와 메모리 사이에서

데이터를 옮기는 일을 하게 된다.

이때 모든 메모리 접근 연산이 CPU에 의해서만 이루어질 경우 I/O 장치가 메모리 접근을 원할 때마다

인터럽트에 의해 CPU의 업무가 방해를 받게 되어 CPU 사용의 효율성이 떨어지는 문제점이 발생한다.

위와 같은 비효율성을 극복하기 위해 CPU 이외에 메모리 접근이 가능한 장치를 DMA라고 한다.

`DMA는 일종의 컨트롤러로 CPU가 I/O 장치들의 메모리 접근 요청에 의해 자주 인터럽트 당하는 것을 막아주는 역할을 한다.`

로컬버퍼에서 메모리로 읽어오는 작업을 CPU가 담당하지 않고, DMA가 대행할 수 있으며

그렇게 되면 CPU는 원래 하던 작업을 멈추고 인터럽트를 처리할 필요가 없어진다.

DMA는 블록이라는 큰 단위로 정보를 메모리로 읽어온 후 CPU에게 인터럽트를 발생시켜 작업의 완료를 알려준다.

DMA는 CPU를 효율적으로 관리하고 I/O 연슨을 빠르게 수행할 수 있는 장점이 있다.

---

### Timer

일반적인 컴퓨터는 CPU가 하나밖에 존재하지 않는다.

어떠한 프로그램이 CPU를 독적해 무한 반복을 수행하거나 부적절한 방법으로 CPU 사용 권한을 독점할 떄에

다른 프로그램이나 운영체제가 CPU를 빼앗을 방법이 없게 된다.

위와 같은 독점 상황을 막기 위해 운영체제는 Timer라는 하드웨어를 사용한다.

`Timer는 정해진 시간이 지나면 인터럽트를 발생시켜 운영체제가 CPU의 제어권을 획득할 수 있도록 하는 역할을 수행`

Timer는 일정 단위로 세팅이 가능하며 매 클럭 틱마다 1씩 감소하고 0이되면 인터럽트를 발생시킨다.

- Load Timer - Timer의 값을 세팅하는 명령

Timer는 시분할 시스템에서 현재 시간을 계산하기 위해서도 사용된다. 대부분의 컴퓨터는 시분할 시스템이다.

- 시분할 시스템 - 여러 프로그램이 CPU의 시간을 조금씩 나누어 사용하는 시스템

**CPU Time sharing**

운영체제가 CPU를 소유하고 있다가 특정 프로그램이 실행되면 Timer를 통해 값을 세팅해서

프로그램에게 CPU를 넘겨준다.

I/O의 경우 프로그램이 자진해서 운영체제에게 I/O를 해달라고 CPU를 넘긴다.

---

### 시스템 콜

사용자 프로그램은 컴퓨터 외부에서 일어난 입출력에 관련된 수행을 직접 할 수 없다.

입출력 명령은 운영체제 코드에 구현되어 있으며, 사용자 프로그램은 직접 입출력을 수행하는 대신

운영체제에게 시스템 콜이라는 서비스 대행 요청을 하여 입출력을 수행한다.

1. 사용자 프로그램이 시스템 콜을 할 경우 트랩 발생
2. CPU의 제어권이 운영체제로 넘어감
3. 운영체제는 해당 시스템 콜을 처리하기 위한 루틴으로 가서 정의된 명령 수행

ex)

1. 시스템 콜이 디스크의 입출력 요청
2. 디스크 컨트롤러에게 입출력 요청을 수행하도록 명령
3. 디스크 컨트롤러가 입출력 수행을 마침
4. CPU에게 인터럽트를 발생시켜 입출력 완료를 알림
5. 해당 프로그램이 다시 CPU를 할당 받음

--- 

## 그 외 용어 간단 정리

- Mode bit - 운영체제 또는 유저 프로그램인지를 구분

    0일 경우 운영체제에서 CPU를 실행(커널 모드)
    1일 경우 사용자 프로그램에서 CPU를 실행

- 버퍼 - 데이터를 한 곳에서 달느 곳으로 전송하는 동안 일시적으로 그 데이터를 보관하는 메모리 영역

## 모바일에서의 입력장치는 어떤 것이 있을까?

디스플레이, Touch 입력 장치, 마이크, 카메라, 스피커, 전원 버튼 , 음량 버튼, 네트워크 송신장치 등등,,,