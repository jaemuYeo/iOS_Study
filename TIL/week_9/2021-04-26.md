이 [강의](https://www.inflearn.com/course/iOS-Concurrency-GCD-Operation/dashboard)를 참고하여 공부하였습니다.

강의 내용을 사용하려면 출처를 밝혀야 하기에,,

오래전 구매해서 묵혀두었던 강의인데 드디어 이번 기회에 이 강의를 볼 기회가 왔다!!

---

# 동시성 프로그래밍, 동기와 비동기

동시성 프로그래밍, 동기와 비동기를 이해하기 위해 프로세스와 스레드에 대한

간단한 이해를 하고 가야할 것 같아 먼저 선수 공부하기로 했다.

[CPU코어와 스레드 개념 간단 설명 영상](https://www.youtube.com/watch?v=_dhLLWJNhwY)

[프로세스와 스레드 영상](https://www.youtube.com/watch?v=iks_Xb9DtTM)

---

## 프로세스

프로세스는 프로그램이 실행되서 돌아가고 있는 상태(컴퓨터가 어떤 일을 하고 있는 상태)를

프로세스라고 한다.

이러한 프로세스는 프로그램에 사용되는 데이터와 메모리 등의 자원 그리고 스레드로 구성된다.

현재 시점에서 컴퓨터 또는 모바일로 쾌적하게 프로그램을 사용할 수 있는건

운영체제가 여러 개의 프로세스를 함께 돌리고 있기 때문이다.

<img width="1072" alt="스크린샷 2021-04-27 오전 12 52 21" src="https://user-images.githubusercontent.com/70311145/116112781-d9b8de80-a6f2-11eb-8927-72dce90d14e0.png">

열일하는 내 컴퓨터,, 😂

여러 프로세스를 함께 돌리는 작업은 **동시적, 병렬적** 또는 이 둘의 혼합으로 이루어진다.

동시성은 프로세서 하나가 이거 조금 저거 조금하면서 여러 작업을 돌아가면서 일부분씩 진행하는 것이다.

병렬성은 프로세서 하나에 코어 여러 개가 달려서 각각 동시에 여러 작업을 수행하는 것이다.

내가 사용하고 있는 기기의 CPU 코어를 알아보았다.

나의 맥북 코어

<img width="213" alt="스크린샷 2021-04-26 오후 8 44 14" src="https://user-images.githubusercontent.com/70311145/116078296-62bf1e00-a6d1-11eb-94ca-99eb5264ef22.png">

나의 아이폰 코어
<img width="641" alt="스크린샷 2021-04-26 오후 8 51 36" src="https://user-images.githubusercontent.com/70311145/116078299-6357b480-a6d1-11eb-8d72-d06937e2f7e4.png">
<img width="268" alt="스크린샷 2021-04-26 오후 8 51 53" src="https://user-images.githubusercontent.com/70311145/116078302-6488e180-a6d1-11eb-9b37-3b7e984c6d1a.png">

CPU의 속도가 발열 등의 문제로 예전만큼 빠르게 발전하지 못해서

다른 방안으로 코어를 여러개 달아서 작업을 분담할 수 있도록 발전이 된 것이다.

---

## 스레드

스레드는 간단하게 말하면 **일을 하는 녀석들**이다.

한 프로세스 안에도 여러 갈래의 작업들이 동시에 진행될 필요가 있다. 이 갈래를 '스레드'라고 한다.

컴퓨터는 프로세스마다 자원을 분할해서 쓰지만 스레드는 프로세스마다 주어진 전체 자원을

함께 사용한다. 속도와 효율면에서는 장점이지만 단점 또한 존재한다.

프로세스 안에 공유되는 변수에 스레드 두개가 동시에 손을 대면 Error가 발생한다.

8스레드라고 하면 일을 하는 녀석이 8개이다, 16스레드이면 일을 하는 녀석이 16개이다와 같은 개념.

---

## 동시성 프로그래밍 이해

<img width="705" alt="스크린샷 2021-04-27 오전 1 58 46" src="https://user-images.githubusercontent.com/70311145/116121958-20f79d00-a6fc-11eb-9382-8a2bd39e0934.png">

하나의 스레드에서만 작업하지만 가벼운 작업을 실행하게되면 당연히 버벅이는 현상은 없다.

예를들어 print함수와 같이 스레드가 엄청나게 빨리 처리할 수 있는 것들이 있다.

```swift
print("고객1 업무 시작")
print("고객1 업무 종료")
print("고객2 업무 시작")
print("고객2 업무 종료")
print("고객3 업무 시작")
print("고객3 업무 종료")
print("고객4 업무 시작")
print("고객4 업무 종료")
```

```swift
func task1() {
    print("고객1 업무 시작")
    print("고객1 업무 종료")
}

func task2() {
    print("고객2 업무 시작")
    print("고객2 업무 종료")
}

func task3() {
    print("고객3 업무 시작")
    print("고객3 업무 종료")
}

func task4() {
    print("고객4 업무 시작")
    print("고객4 업무 종료")
}

task1()
task2()
task3()
task4()

for i in 5...15 {
    print("Task \(i) 시작")
    print("Task \(i) 종료")
}

print("---Test Code---")

/*
고객1 업무 시작
고객1 업무 종료
고객2 업무 시작
고객2 업무 종료
고객3 업무 시작
고객3 업무 종료
고객4 업무 시작
고객4 업무 종료
Task 5 시작
Task 5 종료
Task 6 시작
Task 6 종료
Task 7 시작
Task 7 종료
Task 8 시작
Task 8 종료
Task 9 시작
Task 9 종료
Task 10 시작
Task 10 종료
Task 11 시작
Task 11 종료
Task 12 시작
Task 12 종료
Task 13 시작
Task 13 종료
Task 14 시작
Task 14 종료
Task 15 시작
Task 15 종료
---Test Code---
*/
```

위 코드 처럼 print함수나 이제껏 해왔던 프로젝트들은 아무리 무거워 봤자

단순 모델타입을 데이터로 받아와서 실행하였기에 버벅거리는 현상을 전혀 느끼지 못했다.

하지만 외부의 데이터를 받아오고 네트워크를 통해 압축파일을 다운로드 받고, 압축을 풀고,

이미지 파일을 변형하고 Table View 또는 Collection View의 셀에 이미지를 표시할 때와 같이

하나의 셀을 생성하는 것만으로도 많은 작업량이 필요로 할 때에는 스레드 하나로는 턱없이 부족하다.

<img width="695" alt="스크린샷 2021-04-27 오전 1 54 35" src="https://user-images.githubusercontent.com/70311145/116121415-8a2ae080-a6fb-11eb-9df5-ad83c0cf2cae.png">

이 그림에서 스레드 중 하나의 스레드에서만 무거운 작업을 하게 되면 앱이 버벅 거리는 현상이 발생한다.

그럼 어떻게 다른 스레드로 작업을 분산 시킬 수 있을까??

다른 말로 작업을 어떻게 다른 스레드에서 동시에 일을 하게 할 수 있을까?

이 것이 바로 **동시성 프로그래밍**이라고 한다.

<img width="732" alt="스크린샷 2021-04-27 오전 2 30 02" src="https://user-images.githubusercontent.com/70311145/116125480-80f04280-a700-11eb-9072-fd9bd91d5331.png">

iOS프로그래밍 에서는 작업을 '대기행렬'에 보내기만 하면 알아서 OS가 작업을 분산처리를 해준다.

> 대기행렬 = 큐

<img width="731" alt="스크린샷 2021-04-27 오전 2 34 00" src="https://user-images.githubusercontent.com/70311145/116125999-18ee2c00-a701-11eb-9be1-52e70e9a3f77.png">

이렇게 대기 행렬에 넣는 코드를 작성하기만 하면 OS가 알아서 분산처리를 해주는 것이

iOS에서의 동시성 프로그래밍 이다. (작업을 큐로 보내는 방법을 공부해야겠다,, ㅎㅎ)

<img width="736" alt="스크린샷 2021-04-27 오전 2 35 20" src="https://user-images.githubusercontent.com/70311145/116126158-45a24380-a701-11eb-85ed-3e015e7df662.png">

작업들은 대기열에 들어온 순서대로 먼저 배치가 되는 'FIFO(선입선출)'로 동작한다.

하지만 먼저 배치가 됬다고 해서 그 작업이 먼저 끝난다는 개념은 아니다.

### 동시성(Concurrecny)과 병렬성(Parallelism) 차이

[부스트코스 자료](https://www.boostcourse.org/mo326/lecture/16866?isDesc=false)

동시성 프로그래밍과 병렬성 프로그래밍 모두 비동기 동작을 구현할 수 있지만, 그 동작 원리가 다르다.

- 동시성 : 통장을 만들러 온 N개의 대기열과 한 명 이상의 은행직원
- 병렬성 : 통장을 만들러 온 N개의 대기열과 N명의 은행직원

<img width="390" alt="스크린샷 2021-04-27 오전 2 46 20" src="https://user-images.githubusercontent.com/70311145/116127419-c57cdd80-a702-11eb-8b9e-b74cc00926e5.png">

|                | 동시성               | 병렬성    |
| -------------- | -------------------- | --------- |
| 개념           | 논리적               | 물리적    |
| 동작 가능 환경 | 싱글 코어, 멀티 코어 | 멀티 코어 |

동시성은 싱글코어 및 멀티코어에서 모두 구현할 수 있지만, 병렬성은 멀티 코어에서만 구현할 수 있다.

**iOS 환경 동시성 프로그래밍 지원 종류**

- Grand Central Dispatch (GCD) : 멀티 코어와 멀티 프로세싱 환경에서
  최적화된 프로그래밍을 할 수 있도록 애플이 개발한 기술
- 연산 대기열 (Operation Queue) : 비동기적으로 실행되어야 하는 작업을 객체 지향적인 방법으로 사용
- Thread : 멀티스레드 프로그래밍을 위한 애플에서 제공하는 스레드 클래스

---

## 동기 비동기

동기 - 작업을 다른 스레드에서 하도록 시킨 후, 그 작업이 끝나길 기다렸다가 다음일을 진행.

비동기 - 작업을 다른 스레드에서 하도록 시킨 후, 그 작업이 끝나길 기다리지 않고 다음일을 진행.

[DispatchQueue](https://developer.apple.com/documentation/dispatch/dispatchqueue)

### 동기

일을 시작 시키고, 작업이 끝날때까지 기다리는 것이 동기의 개념이다.

즉, 메인스레드에서 다른 일처리를 하지 못 하도록 블락하고 나서 보낸 작업이 마칠 때까지

기다린다는 뜻이다.

<img width="718" alt="스크린샷 2021-04-27 오전 3 00 03" src="https://user-images.githubusercontent.com/70311145/116129103-aed78600-a704-11eb-9e2b-33f2e35fb766.png">

```swift
DispatchQueue.global().sync {

}
/*
원래의 작업이 진행되고 있던 곳(메인스레드)에서
디스패치 글로벌 큐로 보낸 작업을 동기적으로 기다린다.
*/
```

### 비동기

일을 시작 시키고, 작업이 끝날때까지 기다리지 않는것이 비동기의 개념이다.

즉, 메인스레드가 다른 일 처리를 시작할 수 있다는 뜻이다.

<img width="716" alt="스크린샷 2021-04-27 오전 2 51 30" src="https://user-images.githubusercontent.com/70311145/116128052-7daa8600-a703-11eb-8a09-9844d6f0c6a5.png">

위 그림에서 메인스레드에서 다른 스레드로 작업을 보내고 즉시 리턴되어서(메인스레드로 돌아와서)

두 번째 작업을 처리할 수 있게 하는 것이다.

```swift
DispatchQueue.global().async {

}
/*
원래의 작업이 진행되고 있던 곳(메인스레드)에서
디스패치 글로벌 큐로 보낸 작업을 기다리지 않는다.
*/
```

- 결론적으로는 왜 동기를 사용하다가 비동기라는 개념이 나왔나??

  대부분은 서버와의 통신(네트워크 작업) 때문이다.

  네트워크와 관련된 작업들은 내부적으로 비동기적으로 구현한다.

# 문제점 / 고민한점

1. 프로젝트 Step1에서의 조건에서는 동기와 비동기중 어떤 것으로 구현을 해야할까??

2. 코드를 짜기 전 설계를 해야하는데 큰 틀을 어떻게 잡을까?
