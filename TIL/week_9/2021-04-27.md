# GCD(Grand Central Dispatch), Operation 공부

iOS 환경에서의 동시성 프로그래밍에는 두 가지의 대기행렬이 있다.

동시성은 요약해서 논리적인 용어로 동시에 실행되는 것처럼 보이는 방식이다.

싱글 코어에서 멀티스레드를 동작시키기 위한 방식으로 멀티 태스킹을 위해 여러 개의

스레드가 번걸아가며 실행되는 방식이다.

- GCD - 멀티 코어와 멀티 프로세싱 환경에서 최적화된 프로그래밍을 할 수 있도록 애플이 개발한 기술이다.
- Operation Queue - 비동기적으로 실행되어야 하는 작업을 객체 지향적인 방법으로 사용한다.

---

## GCD - DispatchQueue

[DispatchQueue](https://developer.apple.com/documentation/dispatch/dispatchqueue)

GCD는 백그라운드에서 스레드를 관리하면서 동시적으로 작업을 실행시키는 저수준 API를 제공하는 라이브러리이다.

앱의 기본 스레드 또는 백그라운드 스레드에서 작업 실행을 직렬 또는 동시에 관리하는 개체이다.

스레드 관리를 운영체제에서 관리하기에 개발자가 task를 비동기적으로 간편하게 사용할 수 있다.

개발자가 task를 생성하고 DispatchQueue에 추가하면 GCD는 작업에 맞는 스레드를 자동으로 생성하여 실행 후

작업이 종료되면 스레드를 제거한다.

- Dispatch Queues - FIFO(선입선출)로 작업을 실행시키는 역할을 담당

- Serial Dispatch Queue - 한번에 한 작업만 실행

- Concurrent Dispatch Queue - 시작한 작업이 끝나는 것을 기다리지 않고 가능한 많은 작업ㅇ르 실행

- Main Dispatch Queue - 앱의 메인 스레드에서 작업을 실행할 수 있는 전역에서 사용가능한 시리얼 큐

### DispatchQueue

Dispatch Queue는 GCD에서 사용하는 Queue의 이름이다!

작업을 담고있는 대기열이며 대기열에 추가된 항목은 시스템이 관리하는 스레드 풀에서 처리하고

작업을 완료하면 스레드를 알아서 제거한다.

DispatchQueue는 두 가지로 종류를 나눌 수 있다.

- Serial Disptach Queue - 한 번에 하나의 작업만을 실행하며 이 작업이 끝나서 대기열에서

  제외도고 새로운 작업이 시작되기 전까지 기다린다. 별도로 명시하지 않으면

  DispatchQueue의 기본은 Serial이다.

- Concurrent Disptach Queue - 이미 시작된 작업이 완료될 때까지 기다리지 않고 가능한 많은 작업을 진행한다.

  `병렬처리` 방식

다음은 앱 실행시 시스템에서 기본적으로 두 개의 Queue를 만들어 준다.

- Main Queue - 메인 스레드(UI스레드)에서 사용되는 Serial Queue로 모든 UI처리는 메인 스레드에서 처리해야한다.

- Global Queue - 편의상 사용할수 있게 만들어 놓은 Concurrent Queue이다.

  Global Queue는 처리 우선 순위를 위한 QoS 파라미터를 제공하여 병렬적으로 동시에 처리하기 때문에

  작업 완료의 순서는 정할 수 없지만 우선적으로 일을 처리하게 할 수 있다.

        QoS 우선순위

        - userInteractive - 중요도가 높고 즉각적인 반응이 요구되는 작업으로
                즉각적으로 작업이 처리된다. UI업데이트나 이벤트 핸들링 등에 사용됩니다.
        - userInitiated - 빠른 결과를 기대할 때 사용하는 QoS
        - default
        - utility - 계산, I/O, 네트워킹 등 시간이 다소 오래 걸리는 작업이다.
        - background - 유저가 인지하지도 못하는 백단에서 실행되는 작업이다..
        - unspecified

### 코드

`global dispatch queue에 비동기로 task를 보낸다`는 뜻

```swift
DispatchQueue.global().async {
    // task (작업의 한 단위)
}

DispatchQueue.global().async {
    print("1")
    print("2")
    print("3")
    print("4")
    print("5")
    print("End")
}
```

---

## Operation - OperationQueue

[OperationQueue](https://developer.apple.com/documentation/foundation/operationqueue)

작업과 관련된 코드와 데이터를 나타내는 추상 클래스이다.

### OperationQueue

OperationQueue는 실행 대기중인 작업 라인으로 생각할 수 있다. GCD의 DispatchQueue 대기열과 달리

작업 대기열은 FIFO (선입 선출)가 아니다. 대신, 허용 할 수있는 충분한 시스템 리소스가있는 한

실행할 준비가되는 즉시 작업을 실행한다.

- Operation의 실행을 관리하며, Operation을 담는 `대기열(큐)`이다.

- 큐에 담긴 Operation을 취소하는 방법

  - Operation Object의 cancle() 호출
  - Operation Queue의 cancleAllOperations()를 호출

- KVO를 사용해 작업 진행 상황을 감시할 수 있음

### 코드

```swift
// 선언
// Main Operation Queue 선언 방법
let mainOperation = OperationQueue.main

// Custom Operation Queue 선언 방법
let customOperation = OperationQueue()

customOperation.name = "Custom Queue"
customOperation.qualityOfService = .default

// Add Block Operation
// 1. 블록 선언 후 추가
//instance of operation subclass
let operation = BlockOperation {
    // some task
}
//block: () -> void
customOperation.addOperation(operation)

//2. 선언과 동시에 추가
//add a block : { code }
customOperation.addOperation {
    // some task
}

//multiple tasks
var operations = [Operation]()

operations.append(operation)
operations.append(operation)
}

//ops: [Operation], waitUntilFinished: Bool
customOperation.addOperations(operations, waitUntilFinished: false)


// 3 operations may execute at once
customOperation.maxConcurrentOperationCount = 3

//일시정지
customOperation.isSuspended = true
//다시시작
customOperation.isSuspended = false
```

qualityOfService는 task의 중요성 또는 사용자가 task를 즉각적인 결과에 얼마나 의존 할 것인지를 지정한다.

[Opration 코드 출처](https://riptutorial.com/swift/example/13293/running-tasks-in-an-operationqueue)
